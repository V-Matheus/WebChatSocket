# Diagramas de Fluxo - WebChat Backend

## ğŸ”„ Fluxo Completo: Da ConexÃ£o ao Broadcast

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE CONECTA AO WEBSOCKET                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cliente                          Backend                              Sala
  â”‚                                 â”‚                                  â”‚
  â”‚  HTTP GET /ws/room123           â”‚                                  â”‚
  â”‚  Upgrade: websocket             â”‚                                  â”‚
  â”‚  Sec-WebSocket-Key: xyz...      â”‚                                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                  â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚ 1. Extrai roomId                 â”‚
  â”‚                                 â”‚ 2. Valida key                    â”‚
  â”‚                                 â”‚ 3. Gera Accept hash              â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚  HTTP 101 Switching Protocols   â”‚                                  â”‚
  â”‚  Sec-WebSocket-Accept: abc...   â”‚                                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚     âœ… CONEXÃƒO ESTABELECIDA     â”‚                                  â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚ addClientToRoom(room123, socket) â”‚
  â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                 â”‚                                  â”‚ âœ… Cliente
  â”‚                                 â”‚                                  â”‚    adicionado


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE ENVIA MENSAGEM                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cliente 1                        Backend                         Cliente 2, 3...
  â”‚                                 â”‚                                  â”‚
  â”‚  WebSocket Frame (masked)       â”‚                                  â”‚
  â”‚  Payload: JSON                  â”‚                                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                  â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚ 1. decodeFrame(buffer)           â”‚
  â”‚                                 â”‚    â””â”€> Aplica XOR com mask       â”‚
  â”‚                                 â”‚    â””â”€> Extrai JSON string        â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚ 2. broadcast(roomId, json)       â”‚
  â”‚                                 â”‚    â””â”€> Pega Set de sockets       â”‚
  â”‚                                 â”‚    â””â”€> encodeFrame(json)         â”‚
  â”‚                                 â”‚    â””â”€> forEach: client.write()   â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚  Frame (no mask)                â”‚                                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚          Frame (no mask)         â”‚
  â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚  âœ… Recebe prÃ³pria msg          â”‚      âœ… Recebe msg de Cliente 1  â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE DESCONECTA                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cliente                          Backend                              Sala
  â”‚                                 â”‚                                  â”‚
  â”‚  WebSocket Close Frame          â”‚                                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                  â”‚
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚ Event: 'close'                   â”‚
  â”‚                                 â”‚ removeClientFromRoom(room, sock) â”‚
  â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                 â”‚                                  â”‚ âŒ Cliente
  â”‚                                 â”‚                                  â”‚    removido
  â”‚                                 â”‚                                  â”‚
  â”‚                                 â”‚                   Se room.size==0â”‚
  â”‚                                 â”‚                   â””â”€> Delete salaâ”‚
  â”‚                                 â”‚                                  â”‚
  â”‚  âœ… ConexÃ£o encerrada           â”‚                                  â”‚
```

---

## ğŸ” Detalhamento: Handshake WebSocket

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cliente   â”‚                                              â”‚  Servidor  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                                           â”‚
      â”‚  1. HTTP Request                                          â”‚
      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚  GET /ws/room123 HTTP/1.1                                â”‚
      â”‚  Host: localhost:3000                                    â”‚
      â”‚  Upgrade: websocket                                      â”‚
      â”‚  Connection: Upgrade                                     â”‚
      â”‚  Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==            â”‚
      â”‚  Sec-WebSocket-Version: 13                               â”‚
      â”‚                                                           â”‚
      â”‚                                  2. Servidor recebe       â”‚
      â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚                                     â”‚ handleUpgrade() â”‚   â”‚
      â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                                              â”‚            â”‚
      â”‚                                     3. Extrai roomId      â”‚
      â”‚                                        roomId = "room123" â”‚
      â”‚                                              â”‚            â”‚
      â”‚                                     4. Valida key         â”‚
      â”‚                                        âœ“ Sec-WebSocket-  â”‚
      â”‚                                          Key presente     â”‚
      â”‚                                              â”‚            â”‚
      â”‚                                     5. Gera Accept        â”‚
      â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
      â”‚                           â”‚ generateAcceptValue(key)   â”‚ â”‚
      â”‚                           â”‚                            â”‚ â”‚
      â”‚                           â”‚ key + GUID                 â”‚ â”‚
      â”‚                           â”‚  â””â”€> SHA-1                 â”‚ â”‚
      â”‚                           â”‚      â””â”€> Base64            â”‚ â”‚
      â”‚                           â”‚          â””â”€> Accept hash   â”‚ â”‚
      â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
      â”‚                                              â”‚            â”‚
      â”‚  6. HTTP Response                            â”‚            â”‚
      â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
      â”‚  HTTP/1.1 101 Switching Protocols                        â”‚
      â”‚  Upgrade: websocket                                      â”‚
      â”‚  Connection: Upgrade                                     â”‚
      â”‚  Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=     â”‚
      â”‚                                                           â”‚
      â”‚                                  7. Adiciona Ã  sala       â”‚
      â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚                           â”‚ addClientToRoom(         â”‚   â”‚
      â”‚                           â”‚   "room123",             â”‚   â”‚
      â”‚                           â”‚   socket                 â”‚   â”‚
      â”‚                           â”‚ )                        â”‚   â”‚
      â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                                                           â”‚
      â”‚  âœ… ConexÃ£o WebSocket estabelecida                       â”‚
      â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
      â”‚                                                           â”‚
      â”‚                                  8. Setup handlers        â”‚
      â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚                           â”‚ socket.on('data')        â”‚   â”‚
      â”‚                           â”‚ socket.on('close')       â”‚   â”‚
      â”‚                           â”‚ socket.on('error')       â”‚   â”‚
      â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                                                           â”‚
```

---

## ğŸ“¦ Detalhamento: CodificaÃ§Ã£o/DecodificaÃ§Ã£o de Frame

### Cliente â†’ Servidor (Frame Mascarado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FRAME DO CLIENTE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Byte 0       Byte 1         Bytes 2-5        Bytes 6+
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0x81   â”‚ 0x8A      â”‚  Mask (4 bytes) â”‚  Payload     â”‚
â”‚        â”‚           â”‚                 â”‚  (masked)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚              â”‚               â”‚
   â”‚          â”‚              â”‚               â””â”€> Dados XOR mask
   â”‚          â”‚              â””â”€> ex: [0x12, 0x34, 0x56, 0x78]
   â”‚          â””â”€> 0x8A = 10001010
   â”‚                       â”‚  â””â”€> Length = 10 bytes
   â”‚                       â””â”€> MASK bit = 1
   â””â”€> 0x81 = 10000001
              â”‚      â””â”€> Opcode = 1 (text)
              â””â”€> FIN = 1 (complete)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DECODIFICAÃ‡ÃƒO (Backend)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. LÃª byte 1: 0x8A
   â””â”€> MASK = 1
   â””â”€> Length = 10

2. Extrai mask: bytes 2-5
   mask = [0x12, 0x34, 0x56, 0x78]

3. Extrai payload: bytes 6+
   payload = [0x42, 0x67, 0x23, ...]

4. Decodifica com XOR:
   for i = 0 to payload.length:
     decoded[i] = payload[i] XOR mask[i % 4]

5. Resultado:
   decoded = "OlÃ¡ mundo!"
```

### Servidor â†’ Cliente (Frame NÃƒO Mascarado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FRAME DO SERVIDOR                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Byte 0       Byte 1         Bytes 2+
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0x81   â”‚ 0x0A      â”‚  Payload     â”‚
â”‚        â”‚           â”‚  (no mask)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚              â”‚
   â”‚          â”‚              â””â”€> Dados em texto puro
   â”‚          â””â”€> 0x0A = 00001010
   â”‚                       â””â”€> Length = 10 bytes
   â”‚                       â””â”€> MASK bit = 0 (no mask)
   â””â”€> 0x81 = 10000001
              â””â”€> FIN=1, Opcode=1 (text)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CODIFICAÃ‡ÃƒO (Backend)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: "OlÃ¡ mundo!" (10 bytes)

1. Cria frame header:
   [0x81]  // FIN=1, Opcode=1

2. Adiciona length:
   length = 10 < 126
   â””â”€> [0x81, 0x0A]

3. Adiciona payload:
   [0x81, 0x0A] + Buffer("OlÃ¡ mundo!")

4. Resultado:
   Frame completo = [0x81, 0x0A, 0x4F, 0x6C, 0xC3, ...]
```

---

## ğŸ—‚ï¸ Estrutura de Dados: RoomManager

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ROOMMANAGER                             â”‚
â”‚                    (Singleton)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

rooms: Map<string, Set<Duplex>>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Map                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Key: "room123"  â†’  Value: Set {                            â”‚
â”‚                        socket1 (JoÃ£o)                        â”‚
â”‚                        socket2 (Maria)                       â”‚
â”‚                        socket3 (Pedro)                       â”‚
â”‚                     }                                        â”‚
â”‚                                                              â”‚
â”‚  Key: "abc456"   â†’  Value: Set {                            â”‚
â”‚                        socket4 (Ana)                         â”‚
â”‚                        socket5 (Carlos)                      â”‚
â”‚                     }                                        â”‚
â”‚                                                              â”‚
â”‚  Key: "xyz789"   â†’  Value: Set {                            â”‚
â”‚                        socket6 (Lucas)                       â”‚
â”‚                     }                                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OperaÃ§Ãµes:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  broadcast(roomId, message)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. room = rooms.get(roomId)                    â”‚
â”‚  2. Se !room, return                            â”‚
â”‚  3. frame = encodeFrame(message)                â”‚
â”‚  4. room.forEach(socket => socket.write(frame)) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  addClientToRoom(roomId, socket)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Se !rooms.has(roomId)                       â”‚
â”‚     â””â”€> rooms.set(roomId, new Set())           â”‚
â”‚  2. rooms.get(roomId).add(socket)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  removeClientFromRoom(roomId, socket)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. room = rooms.get(roomId)                    â”‚
â”‚  2. Se !room, return                            â”‚
â”‚  3. room.delete(socket)                         â”‚
â”‚  4. Se room.size == 0                           â”‚
â”‚     â””â”€> rooms.delete(roomId)  // Limpa sala    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â±ï¸ Timeline de uma Mensagem

```
T=0ms    Cliente 1 envia: ws.send('{"text":"OlÃ¡"}')
         â”‚
T=1ms    Buffer chega no servidor (evento 'data')
         â”‚
T=2ms    handleData() chamado
         â”‚
         â”œâ”€> decodeFrame(buffer)
         â”‚   â”œâ”€> LÃª bytes
         â”‚   â”œâ”€> Aplica XOR com mask
         â”‚   â””â”€> Retorna: '{"text":"OlÃ¡"}'
         â”‚
T=3ms    RoomManager.broadcast('room123', message)
         â”‚
         â”œâ”€> rooms.get('room123') â†’ Set {socket1, socket2, socket3}
         â”‚
         â”œâ”€> encodeFrame(message)
         â”‚   â””â”€> Cria frame: [0x81, 0x0E, ...]
         â”‚
T=4ms    forEach: socket.write(frame)
         â”‚
         â”œâ”€> socket1.write() âœ…
         â”œâ”€> socket2.write() âœ…
         â””â”€> socket3.write() âœ…
         â”‚
T=5ms    Clientes recebem (evento 'message')
         â”‚
         â”œâ”€> Cliente 1: onmessage â†’ '{"text":"OlÃ¡"}'
         â”œâ”€> Cliente 2: onmessage â†’ '{"text":"OlÃ¡"}'
         â””â”€> Cliente 3: onmessage â†’ '{"text":"OlÃ¡"}'

Total: ~5ms (rede local)
```

---

## ğŸ” SeguranÃ§a: Por que Mascarar?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PROBLEMA: Cache Poisoning                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Sem mÃ¡scara:

Cliente â†’ Proxy â†’ Servidor

1. Cliente envia frame que PARECE HTTP:
   "GET /admin HTTP/1.1\r\n..."

2. Proxy intermediÃ¡rio pode INTERPRETAR como HTTP
   â””â”€> Cache incorreto
   â””â”€> Ataque de cache poisoning

Com mÃ¡scara:

1. Cliente envia frame MASCARADO (XOR aleatÃ³rio)
   â””â”€> Dados parecem aleatÃ³rios

2. Proxy NÃƒO consegue interpretar
   â””â”€> Apenas repassa bytes

3. Servidor decodifica com XOR
   â””â”€> Recupera mensagem original

RFC 6455, SeÃ§Ã£o 10.3:
"The masking is not intended to protect against attackers
 who have access to the network, but rather to prevent
 caching proxies from interpreting the WebSocket traffic
 as cacheable HTTP traffic."
```

---

## ğŸ“Š ComparaÃ§Ã£o: HTTP vs WebSocket

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HTTP                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cliente                             Servidor
  â”‚  Request                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚  GET /messages HTTP/1.1             â”‚
  â”‚                                     â”‚
  â”‚                    Response         â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  HTTP/1.1 200 OK                    â”‚
  â”‚  [messages]                         â”‚
  â”‚                                     â”‚
  â”‚  âŒ ConexÃ£o fechada                 â”‚

Problema: Cliente precisa POLLAR (repetir requests)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WEBSOCKET                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cliente                             Servidor
  â”‚  Handshake                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚  Upgrade: websocket                 â”‚
  â”‚                                     â”‚
  â”‚                    101 Switching    â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  âœ… CONEXÃƒO PERSISTENTE             â”‚
  â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                     â”‚
  â”‚  Mensagem 1                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                     â”‚
  â”‚                    Mensagem 2       â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                     â”‚
  â”‚  Mensagem 3                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                     â”‚
  â”‚  âœ… Bidirecional + Tempo Real       â”‚

Vantagem: Servidor pode PUSH sem request
```

---

Estes diagramas ilustram todo o funcionamento interno do backend WebSocket! ğŸš€
